---
description: Development LLM operating instructions
---

# ملف توجيهات للنموذج اللغوي المطوّر

> الغرض من هذا الملف هو تعريف النموذج اللغوي المتخصص في التطوير على معمارية مشروع **The Copy**، وأسلوب العمل المتّبع، والقيود التي يجب الالتزام بها عند تنفيذ أي طلب تطويري.

## 1. نظرة عامة على المستودع

- **backend/**: خادم Express مكتوب بـ TypeScript ويقدّم REST APIs، يتضمن الوحدات: `controllers`, `services`, `middleware`, `queues`, `db`, `utils`.
- **frontend/**: تطبيق Next.js 15 (App Router) بـ TypeScript وTailwind، يعتمد على React Query، ويتكامل مع واجهات backend.
- **docs/**: وثائق تقنية، تقارير أداء، وخطط تشغيل.
- **scripts/**: سكربتات فحص الأداء والصيانة.
- ملفات الجذر تشمل إعدادات مثل `package.json`, `pnpm-workspace.yaml`, `start-dev.ps1` لتشغيل الواجهتين معًا.

## 2. المتطلبات والأدوات

1. استخدم **Node.js ≥ 20** و **pnpm** لإدارة الحزم.
2. قم بنسخ ملفات البيئة: `backend/.env.example → backend/.env` و`frontend/.env.example → frontend/.env`، ثم حدّث القيم الحساسة يدويًا (لا تُدرج مفاتيح فعلية في الكود).
3. أوامر التشغيل الأساسية:
   - Backend: `pnpm install` ثم `pnpm dev` تحت مجلد backend.
   - Frontend: `pnpm install` ثم `pnpm dev` تحت مجلد frontend.
   - أو استخدم `powershell -ExecutionPolicy Bypass -File "start-dev.ps1"` من الجذر لتشغيل الواجهتين دفعة واحدة.
4. لتشغيل Redis محليًا استخدم Docker أو خدمة سحابية متوافقة مع BullMQ.

## 3. معايير كتابة الكود

- **TypeScript صارم** في كلا الجزأين؛ حافظ على الأنواع ولا تتجاهل أخطاء `tsc`.
- اتبع تنظيم الوحدات الحالي: منطق الأعمال في `services`, طلبات HTTP في `controllers`, الوظائف المشتركة في `utils`.
- استخدم **Zod** للتحقق من المدخلات على مستوى الـ backend.
- اتبع نمط الرسائل العربية الحالية للمستخدمين النهائيين، مع إبقاء أسماء المتغيرات والواجهات بالإنجليزية.
- تجنّب إضافة تبعيات جديدة ما لم يكن ذلك ضروريًا ومع تبرير واضح.
- أضف تعليقات مختصرة فقط عند وجود منطق معقّد.
- عند التعديل على الملفات التي تستخدم **path aliases** (`@/`) في backend، تأكد من مطابقة التحويلات ضمن `tsconfig.json` والـ build.

## 4. إرشادات تطوير الـ Backend

1. **الخادم**: نقطة الدخول `src/server.ts` تُهيئ Sentry، BullMQ، Prometheus، والـ WebSocket. تأكد من بقاء تهيئة الميدلويرات بنفس الترتيب عند التعديل.
2. **المتحكّمات (Controllers)**: يجب أن تبقى نحيلة، تستدعي الخدمات، وتستخدم الـ logger. طبّق أسلوب معالجة الأخطاء الحالي (رسائل JSON مع حقول `success`, `error`, `code`).
3. **الخدمات (Services)**: مسؤولة عن المنطق المعقّد. حافظ على اختبار الوحدات الموجود (`*.test.ts`).
4. **النظام الخلفي للمهام**: وحدة `src/queues/` تعتمد على BullMQ و Redis. عند إضافة Queue جديدة:
   - عرّف الـ Job في `jobs/`.
   - سجّل العامل في `initializeWorkers`.
   - أضف المراقبة إلى Bull Board إذا لزم الأمر.
5. **الإعداد البيئي**: استخدم `src/config/env.ts` للتحقق من المتغيرات. لا تضف قراءة مباشرة لـ `process.env` خارج هذه الوحدة إلا عند الضرورة.
6. **الاختبارات**: استخدم `pnpm test` أو `pnpm test:coverage` داخل backend. يُفضّل كتابة اختبارات Vitest لأي منطق جديد.

## 5. إرشادات تطوير الـ Frontend

1. يعتمد على **Next.js App Router** (`src/app/(main)/…`). التزم ببنية المجلدات الحالية.
2. استخدم **React Query** للبيانات البعيدة مع مراعاة إعادة التحقق (`refetchInterval`, `staleTime`) كما هو متّبع في `useMetrics.ts`.
3. حافظ على تصميم Tailwind و shadcn/ui؛ لا تُدخل CSS مضمّنًا ما لم يكن بسيطًا جدًا.
4. عند استدعاء واجهات backend تأكد من تمرير `credentials: 'include'` عند الحاجة للمصادقة.
5. استخدم المكونات المشتركة في `src/components` و `src/lib` قبل إنشاء مكونات جديدة.
6. اختبر تغييرات الواجهة باستخدام `pnpm test` أو `pnpm test:smoke`. لأي تدفق جديد مهم، أضف اختبار Playwright (`pnpm e2e`).

## 6. الأداء والمراقبة

- راعِ التكامل مع **Sentry** (backend & frontend) و **Prometheus** (backend). حافظ على إرسال البيانات وعدم كتم الأخطاء بدون تسجيل.
- يوجد دليل تحسين الأداء في `docs/performance-optimization/`. راجع التعليمات قبل إجراء تغييرات قد تؤثر على الأداء أو التخزين المؤقت.
- عند تعديل نظام الطوابير أو Redis، تأكد من توافق الإصدار باستخدام `checkRedisVersion` لتجنب تعطيل BullMQ.

## 7. الأمان والخصوصية

- لا تُخزن الأسرار أو مفاتيح الـ API في المستودع.
- احترم سياسات المصادقة الحالية (JWT + httpOnly cookies). أي تعديل يجب أن يحافظ على نفس مستوى الأمان أو أعلى.
- عالج الأخطاء بطريقة موحدة، ولا تكشف تفاصيل حساسة للمستخدم النهائي.
- فعّل التحقق المدخلي عبر Zod أو Validators المناسبة في كلا الجزأين.

## 8. سير العمل المقترح لكل مهمة

1. **توضيح المتطلبات**: اطلب التفاصيل الناقصة قبل البدء.
2. **جمع السياق**: استعرض الملفات ذات الصلة باستخدام أدوات البحث قبل التعديل.
3. **وضع خطة مختصرة**: جزّئ العمل إلى خطوات واضحة.
4. **تنفيذ مركّز**: عدّل ملفات محددة، مع الالتزام بمعايير المشروع.
5. **التحقق**: شغّل الاختبارات المناسبة وراجع الأخطاء المحتملة.
6. **توثيق التغييرات**: حدّث الوثائق أو ملفات README إذا أثّر التغيير على الاستخدام.
7. **تقرير مختصر**: قدّم ملخّصًا (بالعربية) للتغييرات، مع الإشارة إلى الملفات والأسطر المتأثرة.

## 9. ما يجب أن يتجنبه النموذج

- إدخال تبعيات أو إعدادات بنيوية دون مراجعة تأثيرها على CI/CD أو بيئات التشغيل.
- تعديل ملفات التكوين الحرجة (`tsconfig.json`, `pnpm-workspace.yaml`, `docker-compose.yml` إن وُجد) بدون حاجة مبررة.
- إنشاء قيم افتراضية لحسّاسات الأمان (مثل `JWT_SECRET`) في الإنتاج.
- تخطي الاختبارات أو تسجيل الأخطاء عند حدوثها.

## 10. مصادر إضافية

- `README.md` في الجذر للحصول على نظرة شاملة.
- `backend/BACKEND_DOCUMENTATION.md` لمزيد من التفاصيل عن الخادم.
- `docs/performance-optimization/` لتحسين الأداء.
- `backend/db-performance-analysis/` لتحليلات قاعدة البيانات.

> باتباع الإرشادات أعلاه، سيحافظ النموذج اللغوي على جودة الكود، وأمن التطبيق، وتجربة المستخدم النهائية ضمن مشروع The Copy.

