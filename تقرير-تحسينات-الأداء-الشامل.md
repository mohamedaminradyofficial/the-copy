# ุชูุฑูุฑ ุดุงูู ูุชุญุณููุงุช ุงูุฃุฏุงุก

**ูุดุฑูุน: The Copy**
**ุงูุชุงุฑูุฎ: 2025-11-06**
**ุงูุญุงูุฉ: ุชุญููู ุดุงูู ููุฃุฏุงุก ูุงูุชูุตูุงุช**

---

## 1. ููุฎุต ุชูููุฐู

ููุธูุฑ ุชุญููู ุงููุณุชูุฏุน ุชุทุจูููุง ููุนูุฏูุง ูููุชุนุฏุฏ ุงูุทุจูุงุช ูุจูููุง ููููู "Monorepo" (ุจุงุณุชุฎุฏุงู pnpm-workspace). ูุชููู ุงูุชุทุจูู ูู:

- **ูุงุฌูุฉ ุฃูุงููุฉ (Frontend)**: ุชุทุจูู Next.js 15.4.7 (ูุณุชุฎุฏู App Router) ูุนุชูุฏ ุนูู Tailwind CSS ูููุชุจุงุช UI (ูุซู Radix UI) ูุฅุฏุงุฑุฉ ุญุงูุฉ (React Query).

- **ูุงุฌูุฉ ุฎูููุฉ (Backend)**: ุฎุฏูุฉ Node.js (Express) ูุน Drizzle ORM ููุงุนุฏุฉ ุจูุงูุงุช PostgreSQL (Neon Serverless)ุ ูููุนุฏุฉ ูููุดุฑ ูุญุงููุฉ (Docker).

### 1.1 ููุงุท ุงูููุฉ ุงูุญุงููุฉ โ

- **ูุธุงู ุฐูุงุก ุงุตุทูุงุนู ูุชูุฏู**: 31+ ูููู (Agent) ูุชุฎุตุต ูุน ูุธุงู ุชูุณูู ูุชุทูุฑ
- **ุนูููุงุช ุบูุฑ ูุชุฒุงููุฉ**: ุฎุท ูุนุงูุฌุฉ (Pipeline) ูููู ูู 8+ ุฎุทูุงุช ูุน RAG ููุดู ุงููููุณุฉ
- **Web Workers**: ุฑุณูู ูุชุญุฑูุฉ ููุฌุณููุงุช ุจุฏูู ุชุฌููุฏ ูุงุฌูุฉ ุงููุณุชุฎุฏู (60+ FPS)
- **ุชูุณูู ุงูููุฏ**: 8+ ุตูุญุงุช ุจุงุณุชุฎุฏุงู dynamic imports
- **ุฃูุงู ููู**: CSP Headersุ HSTSุ JWT + bcryptุ ูุนุฏูุงุช ูุญุฏูุฏุฉ (Rate Limiting)
- **ุชุฎุฒูู ูุคูุช ูุชุนุฏุฏ ุงูุทุจูุงุช**: Browser Cacheุ Next.js Cacheุ Redisุ Connection Pooling

### 1.2 ุงูุชุญุฏูุงุช ุงูุญุฑุฌุฉ ๐จ

ุชููู ุชุญุฏูุงุช ุงูุฃุฏุงุก ุงูุฑุฆูุณูุฉ ูู ูุฐุง ุงููุดุฑูุน ูู ุซูุงุซุฉ ูุฌุงูุงุช:

1. **ูุงุนุฏุฉ ุงูุจูุงูุงุช**: ุบูุงุจ ุงูููุงุฑุณ (Indexes) ุนูู ุงูููุงุชูุญ ุงูุฎุงุฑุฌูุฉ
2. **ูุนุงูุฌุฉ ุงูููุงู ุทูููุฉ ุงูุฃูุฏ**: ุนุฏู ูุฌูุฏ ูุธุงู ุทูุงุจูุฑ ุฎูููุฉ (Job Queue)
3. **ุชุฌุฑุจุฉ ุงููุณุชุฎุฏู**: ุนุฏู ูุฌูุฏ ุชุญุฏูุซุงุช ููุฑูุฉ (Streaming) ููููุงู ุงูุทูููุฉ

---

## 2. ุงูุจููุฉ ุงูุชูููุฉ (Technology Stack)

### 2.1 ุงููุงุฌูุฉ ุงูุฃูุงููุฉ (Frontend)

```
ุงูุฅุทุงุฑ ุงูุฃุณุงุณู:      Next.js 15.4.7 + React 18.3.1
ุงููุบุฉ:              TypeScript 5.9.3
ุฅุฏุงุฑุฉ ุงูุญุงูุฉ:       TanStack React Query 5.90.6
ุงูููููุงุช:           Radix UI (15+ ูููู)
ุงูุชูุณูู:            Tailwind CSS 4.1.16
ุงูุฑุณูู ุงููุชุญุฑูุฉ:    Framer Motion 11.0.0
ุงูุฐูุงุก ุงูุงุตุทูุงุนู:   Genkit 1.20.0 + Google Generative AI
ุงูุชุฎุฒูู ุงููุคูุช:     Redis ุนุจุฑ ioredis 5.8.2
ุงูุงุฎุชุจุงุฑุงุช:         Vitest 4.0.6ุ Playwright 1.49.1
ุงููุฑุงูุจุฉ:           Sentry 8.47.0ุ web-vitals 4.2.4
```

**ุงูููุฏูู ุงููุณุชุฎุฏู**: `googleai/gemini-2.5-flash`

### 2.2 ุงููุงุฌูุฉ ุงูุฎูููุฉ (Backend)

```
ุงูุฅุทุงุฑ ุงูุฃุณุงุณู:      Express.js 4.18.2
ูุงุนุฏุฉ ุงูุจูุงูุงุช:     PostgreSQL (Neon Serverless)
ORM:                Drizzle ORM 0.44.7
ุงููุตุงุฏูุฉ:           JWT + bcrypt
ุงูุฐูุงุก ุงูุงุตุทูุงุนู:   Google Generative AI 0.24.1
ุงูุณุฌูุงุช:            Winston 3.11.0
ุงูุฃูุงู:             Helmet 7.1.0ุ CORSุ Rate Limiting
ุงูุฌูุณุงุช:            express-session + connect-pg-simple
```

**ุงูููุฏูู ุงููุณุชุฎุฏู**: `gemini-2.0-flash-exp`

---

## 3. ุงููุงุฌูุฉ ุงูุฃูุงููุฉ (Frontend - Next.js)

### 3.1 ุชุญุณููุงุช ุงูุฃุตูู (Assets Optimization)

#### 3.1.1 ุงูุญุงูุฉ ุงูุญุงููุฉ โ

**ุงูุตูุฑ (Images)**:
- ุงุณุชุฎุฏุงู `next/image` ูู ูุนุธู ุงูุตูุญุงุช
- ุงูุชุญุณูู ุงูุชููุงุฆู (WebPุ Lazy Loadingุ Responsive)

**ุงูุฎุทูุท (Fonts)**:
```typescript
// frontend/src/app/layout.tsx
- ุงุณุชุฎุฏุงู next/font/google
- ุฎุทูุท ูุญุณููุฉ: Geist Sans + Geist Mono
- ุงูุชุญููู ุงูููุณุจู (Preload) ููุฎุทูุท ุงูุญุฑุฌุฉ
```

**ุงูุงุชุตุงูุงุช ุงูููุณุจูุฉ (Preconnect)**:
```typescript
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://generativelanguage.googleapis.com" />
```

#### 3.1.2 ุงูุชูุตูุงุช ููุชุญุณูู ๐ง

**1. ุชุญุณูู ุงูุตูุฑ ุงููุชุจููุฉ**:
```bash
# ุงูุจุญุซ ุนู ุงุณุชุฎุฏุงูุงุช <img> ุงูุชูููุฏูุฉ
frontend/src/components/**/*.tsx
```

**ุงูุญู**:
- ุงุณุชุจุฏุงู ุฌููุน `<img>` ุจู `<Image>` ูู next/image
- ุฅุถุงูุฉ `priority` ููุตูุฑ ูู viewport ุงูุฃููู
- ุงุณุชุฎุฏุงู `placeholder="blur"` ููุตูุฑ ุงูุซุงุจุชุฉ

**2. CDN ููุฃุตูู ุงูุซุงุจุชุฉ**:
```typescript
// next.config.ts - ุฅุถุงูุฉ ููุชุฑุญุฉ
images: {
  domains: ['cdn.example.com'],
  loader: 'cloudinary', // ุฃู imgix
  deviceSizes: [640, 750, 828, 1080, 1200],
  imageSizes: [16, 32, 48, 64, 96],
}
```

### 3.2 ุชูุณูู ุงูููุฏ (Code Splitting)

#### 3.2.1 ุงูุญุงูุฉ ุงูุญุงููุฉ โ

ุชู ุชุทุจูู ุชูุณูู ุงูููุฏ ุจูุฌุงุญ ูู **8+ ุตูุญุงุช**:

```typescript
// ูุซุงู ูู frontend/src/app/(main)/page.tsx
const ParticleBackground = dynamic(() => import('@/components/ParticleBackground'), {
  ssr: false,
  loading: () => <div>ุฌุงุฑู ุงูุชุญููู...</div>,
})
```

**ุงูุตูุญุงุช ุงูููุญุณููุฉ**:
- ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ (`/`)
- ููุญุฉ ุงูุชุญูู (`/dashboard`)
- ุชุญููู ุงููุต (`/script-analysis`)
- ุงููุชุงุฆุฌ (`/results`)
- ุงุณุชูุฏูู ุงููุฎุฑุฌ (`/directors-studio`)
- ูุบูุฑูุง...

#### 3.2.2 ุงูุชูุตูุงุช ุงูุฅุถุงููุฉ ๐ง

**1. ุชูุณูู ุงูููููุงุช ุงูุซูููุฉ**:

```typescript
// ุงูููููุงุช ุงูุชู ูุฌุจ ุชูุณูููุง
- Recharts (ููููุงุช ุงูุฑุณูู ุงูุจูุงููุฉ)
- Framer Motion (ุงูุฑุณูู ุงููุชุญุฑูุฉ ุงูุซูููุฉ)
- Monaco Editor (ุฅุฐุง ููุฌูุฏ)

// ูุซุงู
const Chart = dynamic(() => import('@/components/Chart'), {
  ssr: false,
  loading: () => <ChartSkeleton />,
})
```

**2. ูุฑุงูุจุฉ ุญุฌู ุงูุญุฒูุฉ (Bundle Size)**:

```bash
# ุชูุนูู Bundle Analyzer
ANALYZE=true npm run build

# ุงููุฏู ุงููุทููุจ
- ุงูุญุฒูุฉ ุงูุฑุฆูุณูุฉ: < 250 KB (ูุถุบูุทุฉ)
- ุฃูุจุฑ ุตูุญุฉ: < 500 KB (ูุถุบูุทุฉ)
```

### 3.3 ูุนุงูุฌุฉ ุงูุฌุณููุงุช (Particle System) - Web Workers

#### 3.3.1 ุงูุญุงูุฉ ุงูุญุงููุฉ โ (ููุชุงุฒุฉ)

**ุงูุชุทุจูู ุงูุญุงูู**:

```
ูููุงุช Web Workers:
- frontend/src/workers/particle-generator.worker.ts
- frontend/src/workers/particle-physics.worker.ts
- frontend/src/workers/worker-manager.ts
```

**ุงูุฃุฏุงุก ุงูููุญูู**:
- **ูุจู Web Workers**: 30 FPS ูุน ุชุฌููุฏ UI ููุฏุฉ 2-5 ุซูุงูู
- **ุจุนุฏ Web Workers**: 60+ FPS ุจุฏูู ุชุฌููุฏ
- **ููู ุงูุจูุงูุงุช**: ุงุณุชุฎุฏุงู Transferable Objects (ุตูุฑ ูุณุฎ)
- **ูุนุฏู ุงูุชูููุฏ**: 600 ุฌุณูู ูู 16ms

#### 3.3.2 ุงูุชูุตูุงุช ููุชุญุณูู ๐ง

**1. ุงูุชููู ูุน ุงูุฃุฌูุฒุฉ (Device Detection)**:

```typescript
// ุฅุถุงูุฉ ููุชุฑุญุฉ ูู particle-generator.worker.ts
function getOptimalParticleCount(): number {
  const cores = navigator.hardwareConcurrency || 4;
  const memory = (navigator as any).deviceMemory || 4; // GB

  if (cores >= 8 && memory >= 8) return 8000;
  if (cores >= 4 && memory >= 4) return 4000;
  return 2000; // ุฃุฌูุฒุฉ ุถุนููุฉ
}
```

**2. ุงุญุชุฑุงู ุชูุถููุงุช ุงููุณุชุฎุฏู**:

```typescript
// ุงูุชุญูู ูู prefers-reduced-motion
if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
  // ุชูููู ุนุฏุฏ ุงูุฌุณููุงุช ุฃู ุฅููุงููุง
  particleCount = 0;
}
```

**3. ูุฑุงูุจุฉ ุงูุฃุฏุงุก**:

```typescript
// ููุงุณ FPS ูุถุจุท ุงูุนุฏุฏ ุฏููุงูููููุง
let lastFrameTime = performance.now();
function monitorFPS() {
  const now = performance.now();
  const fps = 1000 / (now - lastFrameTime);

  if (fps < 30) {
    particleCount = Math.floor(particleCount * 0.8);
  }

  lastFrameTime = now;
}
```

### 3.4 ุงูุฃุฏุงุก ุงููููุงุณ (Web Vitals)

#### 3.4.1 ุงูุฃูุฏุงู ุงููุญุฏุฏุฉ โ

```typescript
// frontend/src/lib/web-vitals.ts
ุงูุฃูุฏุงู ุงูููุญุฏุฏุฉ:
- FCP (First Contentful Paint): < 1.8s
- LCP (Largest Contentful Paint): < 2.5s
- CLS (Cumulative Layout Shift): < 0.1
- FID (First Input Delay): < 100ms
- TTFB (Time to First Byte): < 600ms
```

#### 3.4.2 ุงูุชูุตูุงุช ๐ง

**1. ุชูุนูู Sentry**:

```typescript
// frontend/src/lib/web-vitals.ts
// ุญุงูููุง: ูุนุทู (ููุนููู ุจู //)
// ูุฌุจ: ุชูุนูู ุงููุฑุงูุจุฉ ูู Production

export function reportWebVitals(metric: any) {
  console.log(metric);

  // ุชูุนูู ูุฐุง ูู Production
  if (process.env.NODE_ENV === 'production') {
    Sentry.captureMessage(`Web Vital: ${metric.name}`, {
      level: 'info',
      contexts: {
        webVitals: {
          value: metric.value,
          delta: metric.delta,
          id: metric.id,
        },
      },
    });
  }
}
```

**2. ุฅุถุงูุฉ Performance Budget**:

```javascript
// next.config.ts - ุฅุถุงูุฉ ููุชุฑุญุฉ
experimental: {
  performanceBudget: {
    maxInitialLoad: 250000, // 250 KB
    maxPerRoute: 500000,    // 500 KB
  },
}
```

---

## 4. ุงููุงุฌูุฉ ุงูุฎูููุฉ (Backend - Node.js/Drizzle)

### 4.1 ุฃุฏุงุก ูุงุนุฏุฉ ุงูุจูุงูุงุช (Database Performance)

#### 4.1.1 ุงูุจููุฉ ุงูุญุงููุฉ

**ุงูุฌุฏุงูู (6 ุฌุฏุงูู)**:

```sql
-- 1. sessions (ุฌูุณุงุช ุงููุณุชุฎุฏู)
CREATE TABLE sessions (
  sid VARCHAR PRIMARY KEY,
  sess JSONB NOT NULL,
  expire TIMESTAMP NOT NULL,
  INDEX IDX_session_expire ON expire  -- โ ุงูููุฑุณ ุงููุญูุฏ
);

-- 2. users (ุงููุณุชุฎุฏููู)
CREATE TABLE users (
  id VARCHAR PRIMARY KEY (DEFAULT gen_random_uuid()),
  email VARCHAR(255) UNIQUE NOT NULL,
  password_hash TEXT NOT NULL,
  first_name VARCHAR(100),
  last_name VARCHAR(100),
  profile_image_url VARCHAR(500),
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- 3. projects (ุงููุดุงุฑูุน)
CREATE TABLE projects (
  id VARCHAR PRIMARY KEY (DEFAULT gen_random_uuid()),
  title TEXT NOT NULL,
  script_content TEXT,
  user_id VARCHAR REFERENCES users(id) ON DELETE CASCADE,  -- โ๏ธ ุจุฏูู ููุฑุณ
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- 4. scenes (ุงููุดุงูุฏ)
CREATE TABLE scenes (
  id VARCHAR PRIMARY KEY (DEFAULT gen_random_uuid()),
  project_id VARCHAR NOT NULL REFERENCES projects(id) ON DELETE CASCADE,  -- โ๏ธ ุจุฏูู ููุฑุณ
  scene_number INTEGER NOT NULL,
  title TEXT NOT NULL,
  location TEXT NOT NULL,
  time_of_day TEXT NOT NULL,
  characters JSONB NOT NULL,
  description TEXT,
  shot_count INTEGER DEFAULT 0,
  status TEXT DEFAULT 'planned'
);

-- 5. characters (ุงูุดุฎุตูุงุช)
CREATE TABLE characters (
  id VARCHAR PRIMARY KEY (DEFAULT gen_random_uuid()),
  project_id VARCHAR NOT NULL REFERENCES projects(id) ON DELETE CASCADE,  -- โ๏ธ ุจุฏูู ููุฑุณ
  name TEXT NOT NULL,
  appearances INTEGER DEFAULT 0,
  consistency_status TEXT DEFAULT 'good',
  last_seen TEXT,
  notes TEXT
);

-- 6. shots (ุงูููุทุงุช)
CREATE TABLE shots (
  id VARCHAR PRIMARY KEY (DEFAULT gen_random_uuid()),
  scene_id VARCHAR NOT NULL REFERENCES scenes(id) ON DELETE CASCADE,  -- โ๏ธ ุจุฏูู ููุฑุณ
  shot_number INTEGER NOT NULL,
  shot_type TEXT NOT NULL,
  camera_angle TEXT NOT NULL,
  camera_movement TEXT NOT NULL,
  lighting TEXT NOT NULL,
  ai_suggestion TEXT
);
```

**ุฅุนุฏุงุฏุงุช Connection Pool**:
```typescript
max: 20 ุงุชุตุงู
idleTimeoutMillis: 30000 (30 ุซุงููุฉ)
connectionTimeoutMillis: 10000 (10 ุซูุงูู)
```

#### 4.1.2 ุงููุดููุฉ ุงูุญุฑุฌุฉ ๐จ

**ุบูุงุจ ุงูููุงุฑุณ (Indexes)**:
- โ ูุง ุชูุฌุฏ ููุงุฑุณ ุนูู ุงูููุงุชูุญ ุงูุฎุงุฑุฌูุฉ (Foreign Keys)
- โ ูุง ุชูุฌุฏ ููุงุฑุณ ูุฑููุจุฉ (Composite Indexes)
- โ ููุฑุณ ูุงุญุฏ ููุท ุนูู `sessions.expire`

**ุงูุชุฃุซูุฑ**:
- ุงุณุชุนูุงูุงุช ุจุทูุฆุฉ ุนูุฏ ุงูุจุญุซ ุจู `user_id` ุฃู `project_id`
- Full Table Scans ุนูุฏ JOIN
- ุชุฏููุฑ ุงูุฃุฏุงุก ูุน ููู ุงูุจูุงูุงุช

#### 4.1.3 ุงูุญู ุงูููุชุฑุญ ๐ง (ุญุฑุฌ ุฌุฏุงู)

**ุณูุฑูุจุช ุงูููุงุฑุณ ุงููุทููุจ**:

```sql
-- ููู: backend/migrations/001_add_critical_indexes.sql

-- ููุงุฑุณ ุงูููุงุชูุญ ุงูุฎุงุฑุฌูุฉ (Foreign Key Indexes)
CREATE INDEX idx_projects_user_id ON projects(user_id);
CREATE INDEX idx_scenes_project_id ON scenes(project_id);
CREATE INDEX idx_characters_project_id ON characters(project_id);
CREATE INDEX idx_shots_scene_id ON shots(scene_id);

-- ููุงุฑุณ ููุฃุนูุฏุฉ ุงูุฃูุซุฑ ุงุณุชุฎุฏุงููุง ูู ุงูุจุญุซ
CREATE INDEX idx_users_email ON users(email);  -- ูุชุณุฑูุน ุชุณุฌูู ุงูุฏุฎูู

-- ููุงุฑุณ ูุฑููุจุฉ ูุฃููุงุท ุงูุงุณุชุนูุงูุงุช ุงูุดุงุฆุนุฉ
CREATE INDEX idx_scenes_project_status ON scenes(project_id, status);
CREATE INDEX idx_characters_project_name ON characters(project_id, name);
CREATE INDEX idx_projects_user_created ON projects(user_id, created_at DESC);

-- ููุฑุณ ูููุฑุฒ (Ordering)
CREATE INDEX idx_scenes_number ON scenes(project_id, scene_number);
CREATE INDEX idx_shots_number ON shots(scene_id, shot_number);
```

**ุงูุฃููููุงุช**:
1. **ุงูุขู (Critical)**: ููุงุฑุณ FK (4 ููุงุฑุณ ุฃุณุงุณูุฉ)
2. **ูุฐุง ุงูุฃุณุจูุน**: ุงูููุงุฑุณ ุงููุฑููุจุฉ (3 ููุงุฑุณ)
3. **ุงูุดูุฑ ุงููุงุฏู**: ุงูููุงุฑุณ ุงูุฅุถุงููุฉ ุญุณุจ ุฃููุงุท ุงูุงุณุชุฎุฏุงู

**ููุงุณ ุงูุชุญุณูู**:
```sql
-- ูุจู ุฅุถุงูุฉ ุงูููุงุฑุณ
EXPLAIN ANALYZE SELECT * FROM scenes WHERE project_id = 'xxx';
-- ุงููุชูุฌุฉ: Seq Scan (ูุณุญ ุชุณูุณูู - ุจุทูุก)

-- ุจุนุฏ ุฅุถุงูุฉ ุงูููุฑุณ
EXPLAIN ANALYZE SELECT * FROM scenes WHERE project_id = 'xxx';
-- ุงููุชูุฌุฉ: Index Scan (ูุณุญ ุจุงูููุฑุณ - ุณุฑูุน)
```

### 4.2 ุงูุชุฎุฒูู ุงููุคูุช (Caching)

#### 4.2.1 ุงูุญุงูุฉ ุงูุญุงููุฉ โ

**ูุธุงู ุชุฎุฒูู ูุคูุช ูุชุนุฏุฏ ุงูุทุจูุงุช**:

```
ุงูุทุจูุฉ 1: Browser Cache
  - Cache-Control: max-age=31536000
  - ููุฃุตูู ุงูุซุงุจุชุฉ (CSS, JS, ุตูุฑ)

ุงูุทุจูุฉ 2: Next.js Cache
  - API Routes: s-maxage=60, stale-while-revalidate=120
  - ISR (Incremental Static Regeneration)

ุงูุทุจูุฉ 3: Redis Cache
  - ููู: frontend/src/lib/redis.ts
  - TTL ูุงุจู ููุชูููู: 60s - 7 ุฃูุงู

ุงูุทุจูุฉ 4: Database Connection Pool
  - ุฅุนุงุฏุฉ ุงุณุชุฎุฏุงู ุงูุงุชุตุงูุงุช
  - ุชูููู overhead ุงูุงุชุตุงู
```

**ุงูุชุทุจูู ุงูุญุงูู**:

```typescript
// frontend/src/lib/cache-middleware.ts
export async function cacheMiddleware(
  key: string,
  fetchFn: () => Promise<any>,
  ttl: number = 60
) {
  // 1. ูุญุงููุฉ ุงูุญุตูู ูู Redis
  const cached = await redis.get(key);
  if (cached) return JSON.parse(cached);

  // 2. ุฅุฐุง ูู ูููุฌุฏุ ุชูููุฐ ุงูุทูุจ
  const data = await fetchFn();

  // 3. ุญูุธ ูู Redis
  await redis.setex(key, ttl, JSON.stringify(data));

  return data;
}
```

#### 4.2.2 ุงูุชูุตูุงุช ุงูุญุฑุฌุฉ ๐ง

**1. ุชุฎุฒูู ูุชุงุฆุฌ Gemini API** (ุงูุฃููููุฉ ุงููุตูู):

```typescript
// backend/src/services/gemini.service.ts - ุฅุถุงูุฉ ููุชุฑุญุฉ

import { createHash } from 'crypto';
import Redis from 'ioredis';

const redis = new Redis(process.env.REDIS_URL);

export async function analyzeWithCache(text: string, options: AnalysisOptions) {
  // 1. ุฅูุดุงุก ููุชุงุญ ูุฑูุฏ (Hash)
  const cacheKey = createHash('sha256')
    .update(text + JSON.stringify(options))
    .digest('hex');

  const fullKey = `gemini:analysis:${cacheKey}`;

  // 2. ูุญุงููุฉ ุงูุญุตูู ูู Cache
  const cached = await redis.get(fullKey);
  if (cached) {
    console.log('โ Cache HIT - ูุชูุฌุฉ ูู Redis');
    return JSON.parse(cached);
  }

  // 3. ุฅุฐุง ูู ูููุฌุฏุ ุงุณุชุฏุนุงุก Gemini
  console.log('โ Cache MISS - ุงุณุชุฏุนุงุก Gemini API');
  const result = await callGeminiAPI(text, options);

  // 4. ุญูุธ ูู Redis (7 ุฃูุงู)
  await redis.setex(fullKey, 7 * 24 * 60 * 60, JSON.stringify(result));

  return result;
}
```

**ุงูููุงุฆุฏ**:
- โก ุงุณุชุฌุงุจุฉ ููุฑูุฉ ููุทูุจุงุช ุงูููุฑุฑุฉ
- ๐ฐ ุชูููุฑ ุชูุงููู Gemini API (ุจุฏูุงู ูู ุงูุฏูุน ููู ุทูุจ)
- ๐ ุชูููู ุงูุญูู ุนูู ุฎูุงุฏู Google

**2. ุงุณุชุฑุงุชูุฌูุงุช Cache Key**:

```typescript
// ููุงุชูุญ ููุชุฑุญุฉ ูู Redis

// ุงููุดุงุฑูุน
`user:${userId}:projects` - TTL: 5 ุฏูุงุฆู
`project:${projectId}:full` - TTL: 10 ุฏูุงุฆู

// ุงููุดุงูุฏ ูุงูุดุฎุตูุงุช
`project:${projectId}:scenes` - TTL: 3 ุฏูุงุฆู
`project:${projectId}:characters` - TTL: 3 ุฏูุงุฆู

// ุชุญูููุงุช Gemini
`gemini:analysis:${hash}` - TTL: 7 ุฃูุงู
`gemini:seven-stations:${hash}` - TTL: 7 ุฃูุงู

// ุงูุฌูุณุงุช
`session:${sessionId}` - TTL: 24 ุณุงุนุฉ
```

**3. ุฅุจุทุงู Cache ุงูุฐูู (Cache Invalidation)**:

```typescript
// ุนูุฏ ุชุญุฏูุซ ูุดุฑูุนุ ุญุฐู Cache ุงููุฑุชุจุท
export async function updateProject(projectId: string, data: any) {
  // 1. ุชุญุฏูุซ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
  const updated = await db.update(projects)
    .set(data)
    .where(eq(projects.id, projectId));

  // 2. ุญุฐู Cache ุงููุฑุชุจุท
  const userId = updated.user_id;
  await redis.del(
    `user:${userId}:projects`,
    `project:${projectId}:full`,
    `project:${projectId}:scenes`,
    `project:${projectId}:characters`
  );

  return updated;
}
```

### 4.3 ูุนุงูุฌุฉ ููุงู ุงูุฐูุงุก ุงูุงุตุทูุงุนู (AI Task Processing)

#### 4.3.1 ุงูุญุงูุฉ ุงูุญุงููุฉ

**ูุธุงู ูุนุงูุฌุฉ ูุชุทูุฑ (Asynchronous Pipeline)**:

```
ูููุงุช ุงููุธุงู:
- frontend/src/lib/drama-analyst/orchestration/executor.ts (285 ุณุทุฑ)
- frontend/src/lib/drama-analyst/orchestration/orchestration.ts (482 ุณุทุฑ)
```

**ุฎุท ุงููุนุงูุฌุฉ (8 ุฎุทูุงุช)**:

```
ุฅุฑุณุงู ุงูุทูุจ
  โ
ุงูุฎุทูุฉ 0: ุฅุซุฑุงุก RAG (Retrieval-Augmented Generation)
  โโ ุงูููุช: 500-2000ms
  โ
ุงูุฎุทูุฉ 1: ุงูุชูููุฏ ุงูุฃุณุงุณู ุนุจุฑ Genkit
  โโ ุงูููุช: 1-5 ุซูุงูู
  โ
ุงูุฎุทูุฉ 2: ุงูููุฏ ุงูุฐุงุชู (Self-Critique)
  โโ ุงูููุช: 500-1000ms
  โ
ุงูุฎุทูุฉ 2.5: ูุดู ุงููููุณุฉ (Hallucination Detection)
  โโ ุงูููุช: 500-1500ms
  โ
ุงูุฎุทูุฉ 3: ุงูุชุญูู ุงูุฏุณุชูุฑู (Constitutional AI)
  โโ ุงูููุช: 200-500ms
  โ
ุงูุฎุทูุฉ 4: ุชูููู ุนุฏู ุงููููู (Uncertainty Assessment)
  โโ ุงูููุช: 200-500ms
  โ
ุงูุงุณุชุฌุงุจุฉ ุงูููุงุฆูุฉ
  โโ ุงูููุช ุงูุฅุฌูุงูู: 2-10 ุซูุงูู
```

**ุงูุฎุฏูุงุช ุงูููุณุชุฎุฏูุฉ**:
- `RAGService`: ุงุณุชุฑุฌุงุน ุงูุณูุงู ุจูุงุกู ุนูู ุงูููุงุกูุฉ
- `HallucinationService`: ุงูุชุญูู ูู ุงูุญูุงุฆู ููุงุจู ุงููุต ุงููุตุฏุฑ
- `UncertaintyService`: ุชูููู ุงูุซูุฉ
- `SelfCritiqueModule`: ุงูุชุญุณูู ุงูุชูุฑุงุฑู
- `ConstitutionalAI`: ุงูุชุญูู ูู ุงูุฅุฎุฑุงุฌ ุจูุงุกู ุนูู ุงูููุงุนุฏ

**ูุธุงู ุงููููุงุก (Multi-Agent System)**:
- **31+ ูููู ูุชุฎุตุต** (Character Analystุ Plot Analystุ Theme Analystุ ุฅูุฎ)
- ุฑุณู ุจูุงูู ููุชุนุงูู (Collaboration Graph)
- ุฃูุธูุฉ ุฐุงูุฑุฉ: Episodicุ Semanticุ Procedural

#### 4.3.2 ุงููุดููุฉ ุงูุญุฑุฌุฉ ๐จ

**ูุนุงูุฌุฉ ูุชุฒุงููุฉ (Synchronous Processing)**:

```typescript
// ุงููุดููุฉ ุงูุญุงููุฉ
POST /api/analysis/seven-stations
  โ ููุชุธุฑ ุงููุณุชุฎุฏู 2-10 ุซูุงูู
  โ ุฅุฐุง ุชุฌุงูุฒ 30 ุซุงููุฉ โ Request Timeout
  โ ุชุฌุฑุจุฉ ูุณุชุฎุฏู ุณูุฆุฉ
```

**ุงูุณููุงุฑูู ุงูุญุงูู**:
1. ุงููุณุชุฎุฏู ููุฑุณู ูุตูุง ููุชุญููู
2. ุงููุชุตูุญ ููุชุธุฑ (Spinner ูุฏูุฑ)
3. **ุงูุฎุงุฏู ููุนุงูุฌ 8 ุฎุทูุงุช ูุชุชุงููุฉ**
4. ุงููุณุชุฎุฏู ููุชุธุฑ... ููุชุธุฑ... ููุชุธุฑ...
5. ุจุนุฏ 10 ุซูุงูู: ุชุตู ุงููุชูุฌุฉ (ุฃู Timeout!)

#### 4.3.3 ุงูุญู ุงูููุชุฑุญ ๐ง (ุญุฑุฌ ุฌุฏุงู)

**ุชุทุจูู ูุธุงู ุทูุงุจูุฑ ุงูููุงู (Job Queue System)**

##### ุงูุฎูุงุฑ 1: BullMQ (ุงูููุตู ุจู)

**ุงูุชุซุจูุช**:

```bash
cd backend
pnpm add bullmq ioredis
pnpm add -D @types/bullmq
```

**ุงูุจููุฉ ุงูููุชุฑุญุฉ**:

```
backend/src/
โโโ queues/
โ   โโโ analysis.queue.ts        # ุชุนุฑูู ุงูุทุงุจูุฑ
โ   โโโ analysis.worker.ts       # ูุนุงูุฌ ุงูููุงู
โ   โโโ analysis.processor.ts    # ููุทู ุงููุนุงูุฌุฉ
โโโ controllers/
โ   โโโ analysis.controller.ts   # ุชุญุฏูุซ: ุฅุฑุณุงู ููุทุงุจูุฑ
```

**1. ุชุนุฑูู ุงูุทุงุจูุฑ**:

```typescript
// backend/src/queues/analysis.queue.ts

import { Queue } from 'bullmq';
import Redis from 'ioredis';

const connection = new Redis(process.env.REDIS_URL!);

export const analysisQueue = new Queue('analysis-tasks', {
  connection,
  defaultJobOptions: {
    attempts: 3,
    backoff: {
      type: 'exponential',
      delay: 2000,
    },
    removeOnComplete: {
      age: 24 * 3600, // ุญุฐู ุจุนุฏ 24 ุณุงุนุฉ
      count: 100,
    },
    removeOnFail: {
      age: 7 * 24 * 3600, // ุญุฐู ุจุนุฏ 7 ุฃูุงู
    },
  },
});
```

**2. ูุนุงูุฌ ุงูููุงู (Worker)**:

```typescript
// backend/src/queues/analysis.worker.ts

import { Worker, Job } from 'bullmq';
import Redis from 'ioredis';
import { processSevenStations } from './analysis.processor';

const connection = new Redis(process.env.REDIS_URL!);

export const analysisWorker = new Worker(
  'analysis-tasks',
  async (job: Job) => {
    const { text, userId, options } = job.data;

    // ุชุญุฏูุซ ุงูุชูุฏู
    await job.updateProgress(10);
    console.log(`๐ ุจุฏุก ูุนุงูุฌุฉ ูููุฉ: ${job.id}`);

    try {
      // ุงูุฎุทูุฉ 1: RAG Enrichment
      await job.updateProgress(20);
      const ragContext = await enrichWithRAG(text);

      // ุงูุฎุทูุฉ 2-7: Seven Stations Analysis
      await job.updateProgress(30);
      const results = await processSevenStations(text, ragContext, options, job);

      // ุงูุฎุทูุฉ 8: ุญูุธ ุงููุชุงุฆุฌ
      await job.updateProgress(90);
      await saveResults(userId, results);

      await job.updateProgress(100);
      console.log(`โ ุงูุชููุช ุงููููุฉ: ${job.id}`);

      return { success: true, results };

    } catch (error) {
      console.error(`โ ูุดูุช ุงููููุฉ: ${job.id}`, error);
      throw error; // ุณูุชู ุฅุนุงุฏุฉ ุงููุญุงููุฉ ุชููุงุฆููุง
    }
  },
  {
    connection,
    concurrency: 5, // ูุนุงูุฌุฉ 5 ููุงู ูุชุฒุงููุฉ
  }
);

// ูุนุงูุฌุฉ ุงูุฃุญุฏุงุซ
analysisWorker.on('completed', (job) => {
  console.log(`โ ุงููููุฉ ${job.id} ุงูุชููุช ุจูุฌุงุญ`);
});

analysisWorker.on('failed', (job, err) => {
  console.error(`โ ุงููููุฉ ${job?.id} ูุดูุช:`, err);
});

analysisWorker.on('progress', (job, progress) => {
  console.log(`๐ ุงููููุฉ ${job.id}: ${progress}%`);
});
```

**3. ููุทู ุงููุนุงูุฌุฉ**:

```typescript
// backend/src/queues/analysis.processor.ts

import { Job } from 'bullmq';

export async function processSevenStations(
  text: string,
  ragContext: any,
  options: any,
  job: Job
) {
  const stations = [
    'ุฑุตุฏ ุงูุดุฎุตูุงุช',
    'ุชุญููู ุงูุญุจูุฉ',
    'ุงุณุชูุดุงู ุงูููุถูุนุงุช',
    'ุชูููู ุงูุจููุฉ',
    'ุชุญููู ุงูุญูุงุฑ',
    'ุงูุชูููู ุงูููุงุฆู',
    'ุงูุชูุตูุงุช',
  ];

  const results: any = {};
  const progressStep = 60 / stations.length; // 60% ูู ุงูุชูุฏู ูููุญุทุงุช ุงูุณุจุน

  for (let i = 0; i < stations.length; i++) {
    const station = stations[i];
    const currentProgress = 30 + (i * progressStep);

    await job.updateProgress(currentProgress);
    console.log(`๐ ุงููุญุทุฉ ${i + 1}: ${station}`);

    // ุงุณุชุฏุนุงุก Gemini ููุฐู ุงููุญุทุฉ
    results[station] = await analyzeStation(station, text, ragContext, options);

    // ุชุฃุฎูุฑ ุจุณูุท ูุชุฌูุจ Rate Limiting
    await sleep(100);
  }

  return results;
}

function sleep(ms: number) {
  return new Promise(resolve => setTimeout(resolve, ms));
}
```

**4. ุชุญุฏูุซ Controller**:

```typescript
// backend/src/controllers/analysis.controller.ts

import { Request, Response } from 'express';
import { analysisQueue } from '../queues/analysis.queue';

export async function startAnalysis(req: Request, res: Response) {
  const { text, options } = req.body;
  const userId = req.user.id; // ูู JWT

  // 1. ุฅุถุงูุฉ ุงููููุฉ ุฅูู ุงูุทุงุจูุฑ
  const job = await analysisQueue.add('seven-stations', {
    text,
    userId,
    options,
  }, {
    jobId: `analysis-${userId}-${Date.now()}`, // ูุนุฑูู ูุฑูุฏ
  });

  // 2. ุงูุฑุฏ ุงูููุฑู ุนูู ุงููุณุชุฎุฏู
  return res.status(202).json({
    message: 'ุชู ุงุณุชูุงู ุทูุจ ุงูุชุญููู',
    jobId: job.id,
    status: 'queued',
    statusUrl: `/api/analysis/status/${job.id}`,
  });
}

// ููุทุฉ ููุงูุฉ ุฌุฏูุฏุฉ ููุงุณุชุนูุงู ุนู ุงูุญุงูุฉ
export async function getAnalysisStatus(req: Request, res: Response) {
  const { jobId } = req.params;

  const job = await analysisQueue.getJob(jobId);

  if (!job) {
    return res.status(404).json({ error: 'ุงููููุฉ ุบูุฑ ููุฌูุฏุฉ' });
  }

  const state = await job.getState();
  const progress = job.progress;
  const data = job.data;

  if (state === 'completed') {
    const result = job.returnvalue;
    return res.json({
      status: 'completed',
      progress: 100,
      result,
    });
  }

  if (state === 'failed') {
    const error = job.failedReason;
    return res.json({
      status: 'failed',
      error,
    });
  }

  return res.json({
    status: state, // 'waiting' | 'active' | 'delayed'
    progress,
  });
}
```

**5. ุชุญุฏูุซ ุงููุงุฌูุฉ ุงูุฃูุงููุฉ**:

```typescript
// frontend/src/lib/api.ts

export async function analyzeScript(text: string, options: any) {
  // 1. ุฅุฑุณุงู ุทูุจ ุงูุชุญููู
  const response = await fetch('/api/analysis/seven-stations', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ text, options }),
  });

  const { jobId, statusUrl } = await response.json();

  // 2. ุงูุงุณุชุนูุงู ุนู ุงูุญุงูุฉ ูู ุซุงููุฉ
  return new Promise((resolve, reject) => {
    const interval = setInterval(async () => {
      const statusRes = await fetch(statusUrl);
      const status = await statusRes.json();

      if (status.status === 'completed') {
        clearInterval(interval);
        resolve(status.result);
      }

      if (status.status === 'failed') {
        clearInterval(interval);
        reject(new Error(status.error));
      }

      // ุชุญุฏูุซ ุดุฑูุท ุงูุชูุฏู
      onProgress?.(status.progress);

    }, 1000); // ูู ุซุงููุฉ
  });
}
```

**6. ูููู React ููุชูุฏู**:

```typescript
// frontend/src/components/AnalysisProgress.tsx

export function AnalysisProgress() {
  const [progress, setProgress] = useState(0);
  const [status, setStatus] = useState('ุฌุงุฑู ุงูุฅุนุฏุงุฏ...');

  const statusMessages = {
    0: 'ุฌุงุฑู ุงูุฅุนุฏุงุฏ...',
    10: 'ุจุฏุก ุงููุนุงูุฌุฉ...',
    20: 'ุฅุซุฑุงุก ุงููุต ุจุงูุณูุงู...',
    30: 'ุงููุญุทุฉ 1: ุฑุตุฏ ุงูุดุฎุตูุงุช',
    40: 'ุงููุญุทุฉ 2: ุชุญููู ุงูุญุจูุฉ',
    50: 'ุงููุญุทุฉ 3: ุงุณุชูุดุงู ุงูููุถูุนุงุช',
    60: 'ุงููุญุทุฉ 4: ุชูููู ุงูุจููุฉ',
    70: 'ุงููุญุทุฉ 5: ุชุญููู ุงูุญูุงุฑ',
    80: 'ุงููุญุทุฉ 6: ุงูุชูููู ุงูููุงุฆู',
    90: 'ุงููุญุทุฉ 7: ุงูุชูุตูุงุช',
    100: 'ุงูุชูู ุงูุชุญููู! ๐',
  };

  return (
    <div className="space-y-4">
      <Progress value={progress} className="w-full" />
      <p className="text-sm text-muted-foreground text-center">
        {status}
      </p>
    </div>
  );
}
```

##### ุงูุฎูุงุฑ 2: WebSockets (ุจุฏูู ุฃู ููููู)

```typescript
// backend/src/websocket/analysis.socket.ts

import { Server as SocketServer } from 'socket.io';

export function setupAnalysisSocket(io: SocketServer) {
  io.on('connection', (socket) => {
    console.log(`๐ ุนููู ูุชุตู: ${socket.id}`);

    socket.on('subscribe-job', (jobId: string) => {
      socket.join(`job:${jobId}`);
      console.log(`๐ก ุงุดุชุฑู ${socket.id} ูู ุงููููุฉ ${jobId}`);
    });
  });
}

// ูู Worker
analysisWorker.on('progress', async (job, progress) => {
  io.to(`job:${job.id}`).emit('job-progress', {
    jobId: job.id,
    progress,
    message: getProgressMessage(progress),
  });
});

analysisWorker.on('completed', async (job) => {
  io.to(`job:${job.id}`).emit('job-completed', {
    jobId: job.id,
    result: job.returnvalue,
  });
});
```

**ุงููุงุฌูุฉ ุงูุฃูุงููุฉ ูุน Socket.IO**:

```typescript
// frontend/src/hooks/useAnalysisSocket.ts

import { useEffect, useState } from 'react';
import { io, Socket } from 'socket.io-client';

export function useAnalysisSocket(jobId: string) {
  const [progress, setProgress] = useState(0);
  const [result, setResult] = useState(null);
  const [socket, setSocket] = useState<Socket>();

  useEffect(() => {
    const newSocket = io(process.env.NEXT_PUBLIC_WS_URL!);
    setSocket(newSocket);

    newSocket.emit('subscribe-job', jobId);

    newSocket.on('job-progress', (data) => {
      setProgress(data.progress);
    });

    newSocket.on('job-completed', (data) => {
      setResult(data.result);
      setProgress(100);
    });

    return () => {
      newSocket.close();
    };
  }, [jobId]);

  return { progress, result };
}
```

#### 4.3.4 ุงูููุงุฆุฏ ุงููุชููุนุฉ โ

**1. ุชุฌุฑุจุฉ ุงููุณุชุฎุฏู**:
- โ **ุงุณุชุฌุงุจุฉ ููุฑูุฉ** (< 100ms ุจุฏูุงู ูู 10 ุซูุงูู)
- โ **ุดุฑูุท ุชูุฏู ุญูููู** ุจุฏูุงู ูู spinner ุนุงู
- โ **ูุง ุชูุฌุฏ timeouts** - ุงูููุงู ุทูููุฉ ุงูุฃูุฏ ุชูุนุงูุฌ ูู ุงูุฎูููุฉ

**2. ุงูููุซูููุฉ**:
- โ **ุฅุนุงุฏุฉ ูุญุงููุฉ ุชููุงุฆูุฉ** ุนูุฏ ุงููุดู
- โ **ุงุณุชุฑุฏุงุฏ ูู ุงูุฃุนุทุงู** - ุงูููุงู ูุง ุชูููุฏ
- โ **ุชุณุฌูู ุดุงูู** ููู ุฎุทูุฉ

**3. ุงููุงุจููุฉ ููุชูุณุน**:
- โ **ูุนุงูุฌุฉ ูุชุฒุงููุฉ** - 5 ููุงู ูู ููุณ ุงูููุช
- โ **ุชูุฒูุน ุงูุญูู** - ุฅุถุงูุฉ Workers ุฌุฏูุฏุฉ ุจุณูููุฉ
- โ **ุฃููููุงุช ุงูููุงู** - ูุนุงูุฌุฉ ุงูููุงู ุงูุญุฑุฌุฉ ุฃููุงู

**4. ุงููุฑุงูุจุฉ**:
- โ **ููุญุฉ ุชุญูู BullMQ** (`bull-board`)
- โ **ููุงููุณ ุงูุฃุฏุงุก** (ูุนุฏู ุงููุฌุงุญุ ูุชูุณุท ุงูููุช)
- โ **ุชุชุจุน ุงูุฃุฎุทุงุก** ูุน Sentry

---

## 5. ุงูุฃูุงู (Security)

### 5.1 ุงูุญุงูุฉ ุงูุญุงููุฉ โ (ูููุฉ)

**ุงูุชุฑููุณุงุช ุงูุฃูููุฉ (Security Headers)**:

```typescript
// backend/src/middleware/index.ts

CSP (Content Security Policy):
  - default-src: 'self'
  - script-src: 'self' 'unsafe-eval' (ุถุฑูุฑู ูู Gemini)
  - style-src: 'self' 'unsafe-inline'
  - img-src: 'self' data: https:

HSTS (HTTP Strict Transport Security):
  - max-age: 31536000 (ุณูุฉ ูุงุญุฏุฉ)
  - includeSubDomains: true

X-Frame-Options: DENY (ููุน Clickjacking)
X-Content-Type-Options: nosniff
X-XSS-Protection: 1; mode=block
```

**ูุนุฏูุงุช ูุญุฏูุฏุฉ (Rate Limiting)**:

```typescript
ุงููุณุงุฑุงุช ุงูุนุงูุฉ: 100 ุทูุจ / 15 ุฏูููุฉ
ูุณุงุฑุงุช ุงููุตุงุฏูุฉ: 5 ุทูุจุงุช / 15 ุฏูููุฉ (ุญูุงูุฉ Brute Force)
ูุณุงุฑุงุช ุงูุฐูุงุก ุงูุงุตุทูุงุนู: 20 ุทูุจ / ุณุงุนุฉ (ุญูุงูุฉ ุงูููุงุฑุฏ)
```

**ุงููุตุงุฏูุฉ (Authentication)**:
```typescript
JWT: ุชูููุน ุขูู + ุงูุชูุงุก ุตูุงุญูุฉ
bcrypt: ุชุดููุฑ ูููุงุช ุงููุฑูุฑ (10 ุฌููุงุช)
Session: PostgreSQL-backed sessions
```

### 5.2 ุงูุชูุตูุงุช ุงูุฅุถุงููุฉ ๐ง

**1. ุชูุนูู CORS ุงูุตุงุฑู**:

```typescript
// backend/src/server.ts
app.use(cors({
  origin: process.env.ALLOWED_ORIGINS?.split(',') || 'http://localhost:3000',
  credentials: true,
  methods: ['GET', 'POST', 'PUT', 'DELETE'],
  allowedHeaders: ['Content-Type', 'Authorization'],
}));
```

**2. ุงูุชุญูู ูู ุงูุฅุฏุฎุงูุงุช (Input Validation)**:

```typescript
// ุงุณุชุฎุฏุงู Zod ููุชุญูู ูู ุงููุฏุฎูุงุช
import { z } from 'zod';

const analysisSchema = z.object({
  text: z.string().min(50).max(50000),
  options: z.object({
    depth: z.enum(['quick', 'standard', 'deep']),
    language: z.enum(['ar', 'en']),
  }),
});

// ูู Controller
export async function startAnalysis(req: Request, res: Response) {
  try {
    const validated = analysisSchema.parse(req.body);
    // ุงููุชุงุจุนุฉ ุจุฃูุงู...
  } catch (error) {
    return res.status(400).json({ error: 'ุจูุงูุงุช ุบูุฑ ุตุงูุญุฉ' });
  }
}
```

**3. ุชุณุฌูู ูุญุงููุงุช ุงูุงุฎุชุฑุงู**:

```typescript
// Middleware ูููุดู ุนู ูุญุงููุงุช SQL Injection ู XSS
const suspiciousPatterns = [
  /(\%27)|(\')|(\-\-)|(\%23)|(#)/i,  // SQL Injection
  /(<script[^>]*>.*?<\/script>)/gi,  // XSS
];

export function detectAttacks(req: Request, res: Response, next: NextFunction) {
  const allInputs = JSON.stringify(req.body) + JSON.stringify(req.query);

  for (const pattern of suspiciousPatterns) {
    if (pattern.test(allInputs)) {
      logger.warn('๐จ ูุญุงููุฉ ูุฌูู ูุญุชููุฉ', {
        ip: req.ip,
        path: req.path,
        input: allInputs.substring(0, 200),
      });

      return res.status(400).json({ error: 'ุทูุจ ุบูุฑ ุตุงูุญ' });
    }
  }

  next();
}
```

---

## 6. ุงููุฑุงูุจุฉ ูุงูููุงุณ (Monitoring & Metrics)

### 6.1 ุงูุญุงูุฉ ุงูุญุงููุฉ โ๏ธ (ุฌุฒุฆูุฉ)

**ูุชููุฑ**:
- โ Web Vitals tracking (`frontend/src/lib/web-vitals.ts`)
- โ Winston logging (`backend/src/utils/logger.ts`)
- โ๏ธ Sentry (ููุฌูุฏ ููู ูุนุทูู)

**ุบูุฑ ูุชููุฑ**:
- โ ููุญุฉ ุชุญูู ูุฑูุฒูุฉ
- โ ุชูุจููุงุช ุชููุงุฆูุฉ (Alerts)
- โ ุชุชุจุน ุฃุฏุงุก ูุงุนุฏุฉ ุงูุจูุงูุงุช

### 6.2 ุงูุชูุตูุงุช ๐ง

**1. ุชูุนูู Sentry (ุงูุฃููููุฉ)**:

```typescript
// frontend/src/app/layout.tsx

import * as Sentry from '@sentry/nextjs';

if (process.env.NODE_ENV === 'production') {
  Sentry.init({
    dsn: process.env.NEXT_PUBLIC_SENTRY_DSN,
    environment: process.env.NODE_ENV,
    tracesSampleRate: 0.1, // 10% ูู ุงูุทูุจุงุช

    beforeSend(event, hint) {
      // ุชุตููุฉ ุงูุฃุฎุทุงุก ุบูุฑ ุงููููุฉ
      if (event.exception) {
        const error = hint.originalException;
        if (error?.message?.includes('Network Error')) {
          return null; // ุชุฌุงูู ุฃุฎุทุงุก ุงูุดุจูุฉ
        }
      }
      return event;
    },
  });
}
```

**2. ุฅุถุงูุฉ ููุงููุณ ูุฎุตุตุฉ**:

```typescript
// backend/src/metrics/index.ts

import { Counter, Histogram, Registry } from 'prom-client';

const register = new Registry();

// ุนุฏุฏ ุทูุจุงุช Gemini
export const geminiRequestsCounter = new Counter({
  name: 'gemini_requests_total',
  help: 'ุนุฏุฏ ุทูุจุงุช Gemini API',
  labelNames: ['status', 'model'],
  registers: [register],
});

// ูุฏุฉ ูุนุงูุฌุฉ ุงูููุงู
export const analysisProcessingTime = new Histogram({
  name: 'analysis_processing_seconds',
  help: 'ูุฏุฉ ูุนุงูุฌุฉ ุงูุชุญููู ุจุงูุซูุงูู',
  labelNames: ['type'],
  buckets: [1, 2, 5, 10, 30, 60],
  registers: [register],
});

// ููุทุฉ ููุงูุฉ ููููุงููุณ
app.get('/metrics', async (req, res) => {
  res.set('Content-Type', register.contentType);
  res.end(await register.metrics());
});
```

**3. ููุญุฉ ุชุญูู BullMQ**:

```typescript
// backend/src/server.ts

import { createBullBoard } from '@bull-board/api';
import { BullMQAdapter } from '@bull-board/api/bullMQAdapter';
import { ExpressAdapter } from '@bull-board/express';

const serverAdapter = new ExpressAdapter();
serverAdapter.setBasePath('/admin/queues');

createBullBoard({
  queues: [new BullMQAdapter(analysisQueue)],
  serverAdapter,
});

app.use('/admin/queues', serverAdapter.getRouter());

// ุงูุขู ูููู ุงููุตูู ุฅูู:
// http://localhost:5000/admin/queues
// - ุนุฑุถ ุงูููุงู ุงูุญุงููุฉ
// - ุฅุนุงุฏุฉ ูุญุงููุฉ ุงูููุงู ุงููุงุดูุฉ
// - ูุฑุงูุจุฉ ุงูุฃุฏุงุก
```

---

## 7. ุฎุทุฉ ุงูุชูููุฐ (Implementation Roadmap)

### ุงููุฑุญูุฉ 1: ุงูุฃููููุงุช ุงูุญุฑุฌุฉ (ูุฐุง ุงูุฃุณุจูุน) ๐ด

**ุงูููู 1-2: ูุงุนุฏุฉ ุงูุจูุงูุงุช**
- [ ] ุฅุถุงูุฉ ููุงุฑุณ FK (4 ููุงุฑุณ ุฃุณุงุณูุฉ)
- [ ] ุงุฎุชุจุงุฑ ุงูุฃุฏุงุก ูุจู/ุจุนุฏ ุจู EXPLAIN ANALYZE
- [ ] ุชูุซูู ุงูุชุญุณูู ุงูููุญูู

**ุงูููู 3-5: ูุธุงู ุงูุทูุงุจูุฑ**
- [ ] ุชุซุจูุช BullMQ + Redis
- [ ] ุฅูุดุงุก ุทุงุจูุฑ ุงูุชุญููู (Queue)
- [ ] ุฅูุดุงุก ูุนุงูุฌ ุงูููุงู (Worker)
- [ ] ุชุญุฏูุซ Controller + API
- [ ] ุงุฎุชุจุงุฑ ุดุงูู

**ุงูููู 6-7: ุงูุชุฎุฒูู ุงููุคูุช**
- [ ] ุชุทุจูู Cache ููุชุงุฆุฌ Gemini
- [ ] ุฅุถุงูุฉ Cache Invalidation
- [ ] ุงุฎุชุจุงุฑ Cache Hit Ratio

**ุงูุฃุฏูุงุช ุงููุงุฒูุฉ**:
```bash
pnpm add bullmq ioredis
pnpm add @bull-board/api @bull-board/express @bull-board/api/bullMQAdapter
```

### ุงููุฑุญูุฉ 2: ุชุญุณููุงุช ูููุฉ (ุงูุฃุณุจูุน ุงููุงุฏู) ๐ก

**ุงูุฃุณุจูุน 2:**
- [ ] ุชูุนูู Sentry + ูุฑุงูุจุฉ ุงูุฃุฎุทุงุก
- [ ] ุฅุถุงูุฉ WebSockets ููุชุญุฏูุซุงุช ุงูููุฑูุฉ
- [ ] ุชุญุณูู Particle System (Device Detection)
- [ ] ุฅุถุงูุฉ ููุงุฑุณ ูุฑููุจุฉ (3 ููุงุฑุณ)
- [ ] ุฅุนุฏุงุฏ ููุญุฉ ุชุญูู BullMQ

**ุงูุฃุณุจูุน 3:**
- [ ] ุชุญููู Bundle Size
- [ ] ุชุญุณูู Code Splitting ุงูุฅุถุงูู
- [ ] CDN ููุฃุตูู ุงูุซุงุจุชุฉ
- [ ] Performance Budget ูู CI/CD

### ุงููุฑุญูุฉ 3: ุชุญุณููุงุช ุฅุถุงููุฉ (ุงูุดูุฑ ุงููุงุฏู) ๐ข

**ุงูุฃุณุจูุน 4-6:**
- [ ] Server-Sent Events ููุจุซ ุงููุจุงุดุฑ
- [ ] ููุญุฉ ุชุญูู ููุงููุณ ุงูุฃุฏุงุก
- [ ] ุชุญุณูู ุฃููุงุท ุงูุงุณุชุนูุงูุงุช (Query Patterns)
- [ ] Level of Detail (LOD) ููุฌุณููุงุช
- [ ] ุชูุซูู ุดุงูู ููุฃุฏุงุก

---

## 8. ููุงููุณ ุงููุฌุงุญ (Success Metrics)

### 8.1 ุงูุฃูุฏุงู ุงูููุณุชูุฏูุฉ

**ุงููุงุฌูุฉ ุงูุฃูุงููุฉ**:
```
FCP: < 1.8s       (ุงููุฏู ุงูุญุงูู โ)
LCP: < 2.5s       (ุงููุฏู ุงูุญุงูู โ)
CLS: < 0.1        (ุงููุฏู ุงูุญุงูู โ)
FID: < 100ms      (ุงููุฏู ุงูุญุงูู โ)
TTFB: < 600ms     (ุงููุฏู ุงูุญุงูู โ)

Bundle Size:
  - Main: < 250 KB (gzipped)
  - Largest Page: < 500 KB (gzipped)
```

**ุงููุงุฌูุฉ ุงูุฎูููุฉ**:
```
API Response Time:
  - p50: < 200ms
  - p95: < 1000ms
  - p99: < 3000ms

Database Queries:
  - ุจุนุฏ ุงูููุงุฑุณ: < 50ms ูุฃู ุงุณุชุนูุงู ุจุณูุท
  - JOIN queries: < 200ms

Gemini API Cache Hit Rate:
  - ุงููุฏู: > 60% ุจุนุฏ ุฃุณุจูุน
  - ุงููุฏู: > 80% ุจุนุฏ ุดูุฑ
```

**ูุธุงู ุงูุทูุงุจูุฑ**:
```
Job Processing:
  - ููุช ุงูุงูุชุธุงุฑ ูู ุงูุทุงุจูุฑ: < 5 ุซูุงูู
  - ูุนุฏู ุงููุฌุงุญ: > 95%
  - ูุนุฏู ุฅุนุงุฏุฉ ุงููุญุงููุฉ: < 5%
```

### 8.2 ุงูุฃุฏูุงุช ููููุงุณ

```bash
# ููุงุณ Bundle Size
ANALYZE=true npm run build

# ููุงุณ Web Vitals
npx @next/bundle-analyzer

# ููุงุณ ุฃุฏุงุก API
artillery quick --count 100 --num 10 http://localhost:5000/api/health

# ููุงุณ ุงุณุชุนูุงูุงุช ูุงุนุฏุฉ ุงูุจูุงูุงุช
EXPLAIN ANALYZE SELECT * FROM scenes WHERE project_id = 'xxx';
```

---

## 9. ุฎูุงุตุฉ ุงูุชูุฑูุฑ

### 9.1 ุงููุถุน ุงูุญุงูู

**The Copy** ูู ุชุทุจูู ูุชุทูุฑ ููุจูู ุจุดูู ุฌูุฏ ูุน:

**ููุงุท ุงูููุฉ** โ:
- ูุธุงู ุฐูุงุก ุงุตุทูุงุนู ูุชูุฏู (31+ ููููุ 8 ุฎุทูุงุช ูุนุงูุฌุฉ)
- Web Workers ูุนูุงูุฉ (60+ FPS)
- ุชูุณูู ููุฏ ููุชุงุฒ (8+ ุตูุญุงุช)
- ุฃูุงู ููู (CSPุ HSTSุ Rate Limiting)
- ุชุฎุฒูู ูุคูุช ูุชุนุฏุฏ ุงูุทุจูุงุช

**ููุงุท ุงูุถุนู** ๐จ:
- ุบูุงุจ ููุงุฑุณ ูุงุนุฏุฉ ุงูุจูุงูุงุช (ุญุฑุฌ)
- ูุนุงูุฌุฉ ูุชุฒุงููุฉ ููููุงู ุงูุทูููุฉ (ุญุฑุฌ)
- ุนุฏู ูุฌูุฏ ุชุญุฏูุซุงุช ููุฑูุฉ (ููู)

### 9.2 ุงูุชุฃุซูุฑ ุงููุชููุน

**ุจุนุฏ ุงููุฑุญูุฉ 1 (ุฃุณุจูุน)**:
- ๐ **ุณุฑุนุฉ ุงุณุชุนูุงูุงุช ูุงุนุฏุฉ ุงูุจูุงูุงุช**: ุชุญุณูู ุจูุณุจุฉ 70-90%
- โก **ุงุณุชุฌุงุจุฉ API**: ูู 10 ุซูุงูู ุฅูู < 100ms
- ๐ฐ **ุชูููุฑ ุชูุงููู Gemini**: ุจูุณุจุฉ 60-80% ุจูุถู Cache
- โ **ูุนุฏู ูุฌุงุญ ุงูููุงู**: ูู ~85% ุฅูู 95%+

**ุจุนุฏ ุงููุฑุญูุฉ 2 (3 ุฃุณุงุจูุน)**:
- ๐ **ุชุญุฏูุซุงุช ููุฑูุฉ**: ุชุฌุฑุจุฉ ูุณุชุฎุฏู ูุญุณููุฉ
- ๐ฏ **ุชุชุจุน ุงูุฃุฎุทุงุก**: ูุดู ุงููุดุงูู ูุจู ุงููุณุชุฎุฏููู
- ๐ฑ **ุฃุฏุงุก ุงูุฃุฌูุฒุฉ ุงูุถุนููุฉ**: ุชุญุณูู ุจูุณุจุฉ 40%
- ๐ฆ **ุญุฌู ุงูุชุทุจูู**: ุชูููู ุจูุณุจุฉ 15-20%

**ุจุนุฏ ุงููุฑุญูุฉ 3 (ุดูุฑูู)**:
- ๐ **ูุงุจููุฉ ุงูุชูุณุน**: ุฏุนู 10x ุงููุณุชุฎุฏููู ุงูุญุงูููู
- ๐ **ูุฑุงูุจุฉ ุดุงููุฉ**: ุฑุคูุฉ 360 ุฏุฑุฌุฉ ููุฃุฏุงุก
- ๐จ **ุชุฌุฑุจุฉ ูุณุชุฎุฏู**: ุงุณุชุฌุงุจุฉ ููุฑูุฉ ููู ุนูููุฉ
- ๐ฏ **ููุซูููุฉ**: 99.9% Uptime

### 9.3 ุงูุฃููููุฉ ุงูุฃููู (ุงุจุฏุฃ ุงูููู)

```sql
-- 1. ุชูููุฐ ูุฐุง ุงูุณูุฑูุจุช (5 ุฏูุงุฆู)
CREATE INDEX idx_projects_user_id ON projects(user_id);
CREATE INDEX idx_scenes_project_id ON scenes(project_id);
CREATE INDEX idx_characters_project_id ON characters(project_id);
CREATE INDEX idx_shots_scene_id ON shots(scene_id);
```

```bash
# 2. ุชุซุจูุช BullMQ (2 ุฏูุงุฆู)
cd backend
pnpm add bullmq ioredis @bull-board/api @bull-board/express
```

```typescript
// 3. ุฅุถุงูุฉ Cache ูู Gemini (30 ุฏูููุฉ)
// ุฑุงุฌุน ุงููุณู 4.2.2 ููููุฏ ุงููุงูู
```

---

## 10. ุงูููุงุฑุฏ ูุงููุฑุงุฌุน

### 10.1 ุงููุซุงุฆู ุงูุฑุณููุฉ

- [Next.js Performance](https://nextjs.org/docs/app/building-your-application/optimizing)
- [BullMQ Documentation](https://docs.bullmq.io/)
- [Drizzle ORM Indexing](https://orm.drizzle.team/docs/indexes-constraints)
- [Gemini API Best Practices](https://ai.google.dev/gemini-api/docs/best-practices)

### 10.2 ุงูุฃุฏูุงุช ุงููููุฏุฉ

```bash
# ุชุญููู ุงูุฃุฏุงุก
npx lighthouse https://your-app.com --view
npx @next/bundle-analyzer

# ูุฑุงูุจุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุช
npx pg-query-analyzer

# ุงุฎุชุจุงุฑ ุงูุญูู
npx artillery quick --count 1000 --num 50 http://localhost:5000/api/health

# ูุญุต ุงูุฃูุงู
npx snyk test
```

### 10.3 ูููุงุช ุงููุดุฑูุน ุงูุฑุฆูุณูุฉ

**ุงูุฃุฏุงุก**:
- `/home/user/the-copy/frontend/next.config.ts`
- `/home/user/the-copy/frontend/src/lib/web-vitals.ts`
- `/home/user/the-copy/frontend/src/workers/worker-manager.ts`

**ูุงุนุฏุฉ ุงูุจูุงูุงุช**:
- `/home/user/the-copy/backend/src/db/schema.ts`
- `/home/user/the-copy/backend/src/db/index.ts`

**ุงูุฐูุงุก ุงูุงุตุทูุงุนู**:
- `/home/user/the-copy/frontend/src/lib/drama-analyst/orchestration/executor.ts`
- `/home/user/the-copy/backend/src/services/gemini.service.ts`

**ุงูุชุฎุฒูู ุงููุคูุช**:
- `/home/user/the-copy/frontend/src/lib/redis.ts`
- `/home/user/the-copy/frontend/src/lib/cache-middleware.ts`

---

## 11. ุงูุฎุงุชูุฉ

ูุฐุง ุงูุชูุฑูุฑ ููุฏู ุฎุงุฑุทุฉ ุทุฑูู ุดุงููุฉ ูุชุญุณูู ุฃุฏุงุก **The Copy**. ุงูุชุทุจูู ูุจูู ุจุดูู ููุชุงุฒ ููุญุชุงุฌ ููุท ุฅูู ุจุนุถ ุงูุชุญุณููุงุช ุงูุญุฑุฌุฉ ููุตู ุฅูู ูุณุชูู ุงูุฅูุชุงุฌ ุงููุงูู.

**ุงูุฎุทูุงุช ุงูุชุงููุฉ**:
1. โ ูุฑุงุฌุนุฉ ุงูุชูุฑูุฑ ูุน ุงููุฑูู
2. โ ุชุญุฏูุฏ ุฃููููุงุช ุงูุชูููุฐ
3. โ ุชูููุฐ ุงููุฑุญูุฉ 1 (ุงูุฃุณุจูุน ุงูุญุงูู)
4. โ ููุงุณ ุงูุชุญุณูู ูุชูุซููู
5. โ ุงูุงูุชูุงู ุฅูู ุงููุฑุงุญู ุงูุชุงููุฉ

**ุฌุงูุฒ ููุจุฏุกุ** ๐

ุงุจุฏุฃ ุจุงูููุงุฑุณ (5 ุฏูุงุฆู) โ BullMQ (ุณุงุนุฉ) โ Gemini Cache (30 ุฏูููุฉ)

---

**ุชุงุฑูุฎ ุงูุชูุฑูุฑ**: 2025-11-06
**ุงูููุนุฏ**: Claude Code (Comprehensive Performance Analysis)
**ุงูุญุงูุฉ**: ุฌุงูุฒ ููุชูููุฐ โ
